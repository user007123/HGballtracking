<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HoverGreens Vision ‚Äî Ball Debug Mode</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  body { margin:0; background:black; color:white; font-family:Arial; text-align:center;}
  .wrap { width:1180px; margin:10px auto; }
  canvas { width:1180px; height:370px; background:#111; }
  select,button {
    padding:10px 15px; margin:5px;
    background:#111; color:white;
    border:1px solid #555; border-radius:6px;
    font-size:16px; cursor:pointer;
  }
  button.primary { border-color:#4cff70; }
  #log { font-size:14px; color:#0f0; min-height:20px; margin-top:8px; }
</style>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>

<body>
<div class="wrap">
  <h2>HoverGreens Vision ‚Äî BALL DEBUG MODE</h2>

  <select id="cams"></select>
  <button id="start" class="primary">Start Camera</button>
  <button id="setStart">Set Start Spot</button>
  <button id="reset">Reset</button>
  <button id="debugBtn">Debug Ball View</button>

  <div id="log">Loading cameras‚Ä¶</div>

  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="view" width="1180" height="370"></canvas>
</div>

<script>
const cams = document.getElementById("cams");
const startBtn = document.getElementById("start");
const setStartBtn = document.getElementById("setStart");
const resetBtn = document.getElementById("reset");
const debugBtn = document.getElementById("debugBtn");
const log = t => document.getElementById("log").textContent = t;

const video = document.getElementById("video");
const canvas = document.getElementById("view");
const ctx = canvas.getContext("2d");

let debugMode = false;
let cvReady = false;

let startCircle=null;
let waitingCenter=false, waitingEdge=false;

/* ---- CAMERA LOAD ---- */
navigator.mediaDevices.getUserMedia({video:true}).then(async()=>{
  const devs = await navigator.mediaDevices.enumerateDevices();
  devs.filter(d=>d.kind==="videoinput").forEach((cam,i)=>{
    const opt=document.createElement("option");
    opt.value=cam.deviceId;
    opt.text=cam.label||`Camera ${i+1}`;
    cams.appendChild(opt);
  });
  log("‚úÖ Cameras ready ‚Äî choose & Start");
});

/* ---- START CAMERA ---- */
startBtn.onclick = async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{deviceId:{exact:cams.value}}
  });
  video.srcObject = stream;
  await video.play().catch(()=>{});

  log("‚úÖ Camera Live ‚Äî Set Start Spot then Debug Ball Mode");
  requestAnimationFrame(drawFrame);
};

/* ---- SET START ---- */
setStartBtn.onclick = ()=>{ waitingCenter=true; log("üëÜ Click ball CENTER"); };

canvas.onclick = e=>{
  if(!waitingCenter && !waitingEdge) return;

  const r = canvas.getBoundingClientRect();
  const x = (e.clientX-r.left)*(canvas.width/r.width);
  const y = (e.clientY-r.top)*(canvas.height/r.height);

  if(waitingCenter){
    startCircle={x,y,r:0};
    waitingCenter=false; waitingEdge=true;
    log("üëÜ Click ball EDGE");
  } else {
    startCircle.r=Math.hypot(x-startCircle.x,y-startCircle.y);
    waitingEdge=false;
    log("üü¢ Start spot locked ‚Äî turn on Debug Ball View");
  }
};

/* ---- RESET ---- */
resetBtn.onclick = ()=>{ startCircle=null; log("‚Ü∫ Reset"); };

/* ---- DEBUG TOGGLE ---- */
debugBtn.onclick = ()=>{
  debugMode=!debugMode;
  log(debugMode?"üêõ DEBUG ON ‚Äî showing mask":"‚úÖ Debug Off");
};

/* ---- RAW BALL DETECTOR ---- */
function detectBall(){
  let src = new cv.Mat(canvas.height,canvas.width,cv.CV_8UC4);
  new cv.VideoCapture(video).read(src);

  let gray=new cv.Mat(); cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  let mask=new cv.Mat(); cv.threshold(gray,mask,150,255,cv.THRESH_BINARY);

  let cnts=new cv.MatVector(), hier=new cv.Mat();
  cv.findContours(mask,cnts,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  let best=null, maxA=0;
  for(let i=0;i<cnts.size();i++){
    let c=cnts.get(i); let a=cv.contourArea(c);
    if(a>maxA){
      maxA=a;
      let m=cv.moments(c);
      if(m.m00!==0) best={x:m.m10/m.m00, y:m.m01/m.m00};
    }
  }

  // mask preview
  if(debugMode){
    let maskRGBA = new cv.Mat();
    cv.cvtColor(mask, maskRGBA, cv.COLOR_GRAY2RGBA);

    const w=200,h=120;
    const img = new ImageData(
      new Uint8ClampedArray(maskRGBA.data), maskRGBA.cols, maskRGBA.rows
    );
    let tmp=document.createElement("canvas");
    tmp.width=maskRGBA.cols; tmp.height=maskRGBA.rows;
    tmp.getContext("2d").putImageData(img,0,0);
    ctx.drawImage(tmp, canvas.width-w-10, 10, w, h);

    maskRGBA.delete();
  }

  src.delete(); gray.delete(); mask.delete(); cnts.delete(); hier.delete();
  return best;
}

/* ---- FRAME LOOP ---- */
function drawFrame(){
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  ctx.restore();

  if(startCircle){
    ctx.strokeStyle="cyan"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(startCircle.x,startCircle.y,startCircle.r,0,6.28); ctx.stroke();
  }

  if(cvReady){
    let pt = detectBall();
    if(pt){
      ctx.strokeStyle="#00eaff"; ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(pt.x,pt.y,14,0,6.28); ctx.stroke();

      ctx.fillStyle="#00eaff"; ctx.font="20px Arial";
      ctx.fillText(`Ball: ${pt.x.toFixed(0)},${pt.y.toFixed(0)}`,10,25);
    }
  }

  requestAnimationFrame(drawFrame);
}

/* ---- OPENCV READY ---- */
cv.onRuntimeInitialized = ()=>{ cvReady=true; log("‚úÖ CV Ready ‚Äî debug ball now"); };
</script>
</body>
</html>
