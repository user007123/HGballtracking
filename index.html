<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HoverGreens Vision â€” Ball Lock Engine</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:Arial;text-align:center;}
  canvas{display:block;margin:6px auto;background:#000;}
  video{display:none}
  #status{margin:8px;font-size:14px;color:#00ff9c;}
</style>
</head>
<body>

<h3>HoverGreens Vision â€” Ball Tracking</h3>
<div id="status">Initializing cameraâ€¦</div>

<video id="cam" autoplay playsinline muted></video>
<canvas id="proc" width="960" height="540"></canvas>
<canvas id="view" width="1180" height="370"></canvas>

<script>
const statusEl=document.getElementById("status");
const vid=document.getElementById("cam");
const proc=document.getElementById("proc");
const pctx=proc.getContext("2d",{willReadFrequently:true});
const view=document.getElementById("view");
const vctx=view.getContext("2d",{willReadFrequently:true});

// Detection constants tuned to YOUR readings
const BRIGHT_MIN=200;
const SAT_MAX=0.12;
const MIN_CLUSTER=5;
const MAX_CLUSTER=120;

// Start zone right/middle
const startZone={
 x:view.width*0.70,
 y:view.height*0.45,
 w:view.width*0.16,
 h:view.height*0.25
};

let tracking=false, still=0, kal=null;
let trail=[], buf=[];
const delay=5;

// Smooth tiny motion
const smooth=(a,b)=>!a?b:{x:a.x*0.7+b.x*0.3,y:a.y*0.7+b.y*0.3};

// Camera
navigator.mediaDevices.getUserMedia({
 video:{width:{ideal:1920},height:{ideal:1080},facingMode:"environment"},
 audio:false
}).then(s=>{
 vid.srcObject=s;
 vid.onloadedmetadata=()=>{
  statusEl.textContent="ðŸ“· Ready â€” put ball in right zone";
  vid.play();
  loop();
};
});

function loop(){

 // Process frame small
 pctx.drawImage(vid,0,0,proc.width,proc.height);
 const frame=pctx.getImageData(0,0,proc.width,proc.height).data;
 const mask=new Uint8Array(proc.width*proc.height);

 for(let i=0;i<frame.length;i+=4){
  const r=frame[i],g=frame[i+1],b=frame[i+2];
  const bright=(r+g+b)/3;
  const maxC=Math.max(r,g,b), minC=Math.min(r,g,b);
  const sat=(maxC-minC)/(maxC+1);

  if(bright>BRIGHT_MIN && sat<SAT_MAX){
    mask[i/4]=1;
  }
 }

 // Find ball cluster (tiny blob)
 let ball=null;
 for(let y=0;y<proc.height;y++){
  for(let x=0;x<proc.width;x++){
    const idx=y*proc.width+x;
    if(mask[idx]===1){
      let sx=0,sy=0,count=0;
      const stack=[[x,y]];
      mask[idx]=0;

      while(stack.length){
        const [cx,cy]=stack.pop();
        const id=cy*proc.width+cx;
        sx+=cx; sy+=cy; count++;

        for(const [dx,dy] of[[1,0],[-1,0],[0,1],[0,-1]]){
          let nx=cx+dx,ny=cy+dy;
          if(nx>=0&&nx<proc.width&&ny>=0&&ny<proc.height){
            const nid=ny*proc.width+nx;
            if(mask[nid]===1){ mask[nid]=0; stack.push([nx,ny]); }
          }
        }
      }

      if(count>MIN_CLUSTER && count<MAX_CLUSTER){
        ball={
         x:(sx/count)*(view.width/proc.width),
         y:(sy/count)*(view.height/proc.height)
        };
      }
    }
  }
 }

 // Draw mirrored camera
 vctx.save();
 vctx.scale(-1,1);
 vctx.drawImage(vid,-view.width,0,view.width,view.height);
 vctx.restore();

 // Draw start zone
 vctx.strokeStyle="#00ff88"; vctx.lineWidth=3;
 vctx.strokeRect(startZone.x,startZone.y,startZone.w,startZone.h);

 if(ball){
   const inBox = ball.x>startZone.x && ball.x<startZone.x+startZone.w &&
                 ball.y>startZone.y && ball.y<startZone.y+startZone.h;

   if(!tracking && inBox){
     tracking=true;
     trail=[]; buf=[]; still=0; kal=null;
     statusEl.textContent="ðŸš€ Ball detected â€” roll!";
   }

   if(tracking){
    kal=smooth(kal,ball);
    buf.push(kal);

    if(buf.length>delay){
      const pt=buf.shift();
      trail.push(pt);

      // draw trail
      if(trail.length>1){
        vctx.strokeStyle="#00ff80"; vctx.lineWidth=4;
        vctx.beginPath();
        vctx.moveTo(trail[0].x,trail[0].y);
        for(let i=1;i<trail.length;i++) vctx.lineTo(trail[i].x,trail[i].y);
        vctx.stroke();
      }

      // stop detection
      if(trail.length>5){
       const d=Math.hypot(
        trail.at(-1).x-trail.at(-4).x,
        trail.at(-1).y-trail.at(-4).y
       );
       if(d<1.5){
        still++;
        if(still>5){
          tracking=false;
          const p=trail.at(-1);
          vctx.strokeStyle="#00ffff"; 
          vctx.beginPath(); 
          vctx.arc(p.x,p.y,10,0,2*Math.PI); 
          vctx.stroke();
          statusEl.textContent="â›³ Ball stopped";
        }
       }
      }
    }
   }
 }

 requestAnimationFrame(loop);
}
</script>
</body>
</html>
