<!DOCTYPE html>
<html>
<head>
<title>HoverGreens Ball Tracking</title>
<style>
  body {
    margin:0;
    background:black;
    color:white;
    font-family:Arial, sans-serif;
    text-align:center;
  }
  #canvas {
    display:block;
    margin:auto;
  }
  #status {
    font-size:22px;
    margin-top:8px;
  }
</style>
</head>

<body>
<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas"></canvas>
<div id="status">üü¢ Loading OpenCV‚Ä¶</div>

<!-- ‚úÖ Use YOUR local opencv.js file in GitHub -->
<script src="opencv.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let cap, frame, fgmask, mog;
let lastBall = {x:null, y:null};
let ballWasMoving = false;

function startCamera() {
  navigator.mediaDevices.getUserMedia({
    video: { facingMode:"environment" },
    audio: false
  })
  .then(stream => {
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      video.play();
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;

      frame  = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
      fgmask = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
      mog = new cv.BackgroundSubtractorMOG2(200, 25, false);

      cap = new cv.VideoCapture(video);
      document.getElementById("status").textContent = "üì∑ Camera ready ‚Äî roll ball";
      requestAnimationFrame(loop);
    };
  })
  .catch(err => {
    document.getElementById("status").textContent = "‚ùå Camera error: " + err;
  });
}

function loop() {
  // draw video frame
  ctx.drawImage(video, 0,0, canvas.width, canvas.height);
  
  try { cap.read(frame); } catch(e) {
    requestAnimationFrame(loop);
    return;
  }

  // background subtractor to find motion
  mog.apply(frame, fgmask);
  cv.threshold(fgmask, fgmask, 200, 255, cv.THRESH_BINARY);
  cv.morphologyEx(fgmask, fgmask, cv.MORPH_OPEN, cv.Mat.ones(5,5,cv.CV_8U));

  // find moving blob = ball
  let contours = new cv.MatVector();
  let hierarchy = new cv.Mat();
  cv.findContours(fgmask, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

  let bestArea = 0, bx = null, by = null;

  for (let i = 0; i < contours.size(); i++) {
    let cnt  = contours.get(i);
    let area = cv.contourArea(cnt);

    if (area > 25 && area < 2000 && area > bestArea) {
      let rect = cv.boundingRect(cnt);
      bx = rect.x + rect.width / 2;
      by = rect.y + rect.height / 2;
      bestArea = area;
    }
  }

  if (bx && by) {
    ballWasMoving = true;
    lastBall = { x:bx, y:by };

    ctx.beginPath();
    ctx.arc(bx, by, 6, 0, Math.PI*2);
    ctx.fillStyle = "lime";
    ctx.fill();

    document.getElementById("status").textContent = "üèÉ Ball moving‚Ä¶";
  }
  else if (ballWasMoving) {
    ballWasMoving = false;

    if (lastBall.x) {
      ctx.beginPath();
      ctx.arc(lastBall.x, lastBall.y, 12, 0, Math.PI*2);
      ctx.lineWidth = 4;
      ctx.strokeStyle = "cyan";
      ctx.stroke();

      document.getElementById("status").textContent = "‚õ≥ Ball stopped ‚Äî position locked";
    }
  }

  requestAnimationFrame(loop);
}

// ‚úÖ When OpenCV is ready, start
cv.onRuntimeInitialized = () => {
  document.getElementById("status").textContent = "‚úÖ OpenCV ready ‚Äî activating camera";
  startCamera();
};
</script>
</body>
</html>
