<script>
const camSelect = document.getElementById("cameraSelect");
const startBtn = document.getElementById("startBtn");
const setStartBtn = document.getElementById("setStartBtn");
const resetBtn = document.getElementById("resetBtn");
const statusEl = document.getElementById("status");
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let cvReady = false;
let startCircle = null;
let waitingCenter = false;
let waitingEdge = false;

let tracing = false;
let path = [];
let lastPos = null;
let speedEMA = 0;
let stillFrames = 0;

function msg(t){ statusEl.textContent = t; }

/* CAMERA LIST */
async function loadCams() {
  await navigator.mediaDevices.getUserMedia({video:true});
  const devs = await navigator.mediaDevices.enumerateDevices();
  devs.filter(d=>d.kind==="videoinput").forEach((cam,i)=>{
    const o=document.createElement("option");
    o.value=cam.deviceId; o.text=cam.label||`Camera ${i+1}`;
    camSelect.appendChild(o);
  });
  msg("âœ… Cameras ready â€” pick one");
}
loadCams();

/* START CAM */
async function startCam(){
  const id = camSelect.value;
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{deviceId:{exact:id}}
  });
  video.srcObject = stream;
  video.onloadedmetadata = ()=>{
    video.play();
    msg("ðŸ“ Click 'Set Start Spot'");
    requestAnimationFrame(loop);
  };
}
startBtn.onclick = startCam;

/* CALIBRATE START SPOT */
setStartBtn.onclick = ()=>{
  waitingCenter = true;
  msg("ðŸ‘† Click ball center");
};

canvas.onclick = (e)=>{
  if (!waitingCenter && !waitingEdge) return;
  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * (canvas.width/r.width);
  const y = (e.clientY - r.top) * (canvas.height/r.height);

  if(waitingCenter){
    startCircle = {x,y,r:0};
    waitingCenter=false; waitingEdge=true;
    msg("ðŸ‘† Click ball edge");
  }
  else if(waitingEdge){
    startCircle.r = Math.hypot(x-startCircle.x,y-startCircle.y);
    waitingEdge=false;
    msg("ðŸš¦ Place ball & roll â€” tracer arms when ball leaves circle");
  }
};

/* RESET */
resetBtn.onclick = ()=>{
  tracing=false; path=[]; lastPos=null; stillFrames=0; speedEMA=0;
  msg("â†º Reset â€” ready");
};

/* BALL DETECTOR */
function detectBall(){
  let src = new cv.Mat(canvas.height, canvas.width, cv.CV_8UC4);
  new cv.VideoCapture(video).read(src);
  let hsv = new cv.Mat(); cv.cvtColor(src,hsv,cv.COLOR_RGBA2HSV);
  let low=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[0,0,190,0]);
  let high=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[180,60,255,255]);
  let mask=new cv.Mat(); cv.inRange(hsv,low,high,mask);

  // fallback: find largest blob center
  let cnts=new cv.MatVector(), hier=new cv.Mat();
  cv.findContours(mask,cnts,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  let bestArea=0, best=null;
  for(let i=0;i<cnts.size();i++){
    let cnt = cnts.get(i);
    let a = cv.contourArea(cnt);
    if(a>bestArea){
      bestArea=a;
      let m=cv.moments(cnt);
      best = m.m00!==0 ? {x:m.m10/m.m00, y:m.m01/m.m00} : null;
    }
  }

  src.delete(); hsv.delete(); low.delete(); high.delete(); mask.delete(); cnts.delete(); hier.delete();
  return best;
}

/* MAIN LOOP */
function loop(){
  // draw mirrored turf
  ctx.save(); ctx.scale(-1,1);
  ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  ctx.restore();

  // draw start circle
  if(startCircle){
    ctx.strokeStyle="cyan"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(startCircle.x,startCircle.y,startCircle.r,0,6.28); ctx.stroke();
  }

  if(cvReady){
    let pt = detectBall();
    if(pt){
      // draw ball
      ctx.fillStyle="#fff";
      ctx.beginPath(); ctx.arc(pt.x,pt.y,6,0,6.28); ctx.fill();

      if(startCircle && !tracing){
        let d = Math.hypot(pt.x-startCircle.x,pt.y-startCircle.y);
        if(d > startCircle.r+2){
          tracing = true;
          path=[pt];
          lastPos = {...pt, t:performance.now()};
          msg("ðŸš€ Ball left start â€” tracing!");
        }
      }

      if(tracing){
        let now=performance.now();
        let dt=(now-lastPos.t)/1000;
        let dist=Math.hypot(pt.x-lastPos.x,pt.y-lastPos.y);
        let speed=dist/dt;
        speedEMA = 0.2*speed + 0.8*speedEMA;

        if(dist > 0.5){
          path.push(pt);
          lastPos={...pt,t:now};
        }

        if(speedEMA < 6){
          stillFrames++;
          if(stillFrames>10){
            tracing=false;
            let end=path[path.length-1];
            ctx.strokeStyle="#ff4040"; ctx.lineWidth=3;
            ctx.beginPath(); ctx.arc(end.x,end.y,10,0,6.28); ctx.stroke();
            msg("â›³ Ball stopped");
          }
        } else stillFrames=0;
      }
    }
  }

  // draw path
  if(path.length>1){
    ctx.strokeStyle="#00ff80"; ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(path[0].x,path[0].y);
    for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x,path[i].y);
    ctx.stroke();
  }

  requestAnimationFrame(loop);
}

/* OPENCV READY */
cv.onRuntimeInitialized = () => {
  cvReady = true;
  msg("âœ… OpenCV loaded â€” click Start Spot then film ball");
};
</script>
