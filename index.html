<!DOCTYPE html>
<html>
<head>
<title>HoverGreens Ball Detector</title>
<style>
  body { margin:0; background:#000; color:white; font-family:Arial; text-align:center; }
  #canvas { display:block; margin:auto; }
  #status { font-size:22px; margin-top:10px; }
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas"></canvas>
<div id="status">ðŸŸ¢ Loading OpenCVâ€¦</div>

<script src="opencv.js"></script>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");

let cap, src, gray, circles;
let ready = false;

// âœ… Start camera
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode:"environment" }})
  .then(stream => {
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // âœ… Initialize OpenCV mats AFTER video size exists
      src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
      gray = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
      circles = new cv.Mat();
      cap = new cv.VideoCapture(video);

      ready = true;
      document.getElementById("status").textContent = "ðŸ“· Camera started â€” place ball on green";
      requestAnimationFrame(loop);
    };
  })
  .catch(err => {
    document.getElementById("status").textContent = "âŒ Camera error: " + err;
  });
}

// âœ… Circle-based golf ball detection
function detectBallCircle(frame) {
  cv.cvtColor(frame, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(9,9), 2,2);

  circles = new cv.Mat();

  cv.HoughCircles(
    gray, circles, cv.HOUGH_GRADIENT,
    1, 20,
    100, 15,  // detection thresholds
    8, 40     // min/max radius in px (overhead tuned)
  );

  if (circles.rows > 0) {
    let x = circles.data32F[0];
    let y = circles.data32F[1];
    let r = circles.data32F[2];
    return { x, y, r };
  }

  return null;
}

// âœ… Safe frame loop
function loop() {
  // wait for video frames
  if (!ready || video.videoWidth === 0) {
    requestAnimationFrame(loop);
    return;
  }

  try { cap.read(src); } catch(e) {
    requestAnimationFrame(loop);
    return;
  }

  cv.imshow(canvas, src);

  let ball = detectBallCircle(src);
  if (ball) {
    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "cyan";
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.stroke();

    document.getElementById("status").textContent = "âœ… Ball detected!";
  }

  requestAnimationFrame(loop);
}

// âœ… OpenCV ready â†’ start camera
cv['onRuntimeInitialized'] = () => {
  document.getElementById("status").textContent = "âœ… OpenCV loaded â€” starting cameraâ€¦";
  startCamera();
};
</script>

</body>
</html>
