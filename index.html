<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HoverGreens Vision ‚Äî Ball Debug</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  body { margin:0; background:black; color:white; font-family:Arial; text-align:center; }
  .wrap { width:1180px; margin:10px auto; }
  canvas { width:1180px; height:370px; background:#111; }
  select,button {
    padding:10px 15px; margin:5px;
    background:#111; color:white;
    border:1px solid #555; border-radius:6px;
    font-size:16px; cursor:pointer;
  }
  button.primary { border-color:#4cff70; }
  #log { font-size:14px; color:#0f0; min-height:20px; margin-top:8px; }
</style>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
</head>

<body>

<div class="wrap">
  <h2>HoverGreens Vision ‚Äî Ball Detection Debug</h2>

  <select id="cams"></select>
  <button id="start" class="primary">Start Camera</button>
  <button id="setStart">Set Start Spot</button>
  <button id="reset">Reset</button>
  <button id="debugBtn">Debug Ball View</button>

  <div id="log">Loading cameras‚Ä¶</div>

  <video id="video" autoplay playsinline style="display:none;"></video>
  <canvas id="view" width="1180" height="370"></canvas>
</div>

<script>
/* DOM refs */
const cams = document.getElementById("cams");
const startBtn = document.getElementById("start");
const setStartBtn = document.getElementById("setStart");
const resetBtn = document.getElementById("reset");
const debugBtn = document.getElementById("debugBtn");
const log = t => document.getElementById("log").textContent = t;

const video = document.getElementById("video");
const canvas = document.getElementById("view");
const ctx = canvas.getContext("2d");

/* State */
let debugMode = false;
let cvReady = false;
let startCircle = null;
let waitingCenter = false, waitingEdge = false;

/* Get cameras */
navigator.mediaDevices.getUserMedia({video:true}).then(async()=>{
  const devs = await navigator.mediaDevices.enumerateDevices();
  devs.filter(d=>d.kind==="videoinput").forEach((cam,i)=>{
    const opt=document.createElement("option");
    opt.value=cam.deviceId;
    opt.text=cam.label||`Camera ${i+1}`;
    cams.appendChild(opt);
  });
  log("‚úÖ Cameras ready ‚Äî choose one");
});

/* Start camera */
startBtn.onclick = async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{deviceId:{exact:cams.value}}
  });
  video.srcObject = stream;
  await video.play().catch(()=>{});

  log("‚úÖ Camera streaming ‚Äî click 'Set Start Spot'");

  requestAnimationFrame(drawFrame);
};

/* Click-to-set start circle */
setStartBtn.onclick = ()=>{
  waitingCenter = true;
  log("üëÜ Click ball CENTER");
};

canvas.onclick = e=>{
  if(!waitingCenter && !waitingEdge) return;

  const r = canvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * (canvas.width/r.width);
  const y = (e.clientY - r.top) * (canvas.height/r.height);

  if(waitingCenter){
    startCircle = {x,y,r:0};
    waitingCenter = false;
    waitingEdge = true;
    log("üëÜ Click ball EDGE");
  }
  else if(waitingEdge){
    startCircle.r = Math.hypot(x-startCircle.x,y-startCircle.y);
    waitingEdge = false;
    log("üü¢ Start circle set ‚Äî debug ball tracking");
  }
};

/* Reset */
resetBtn.onclick = ()=>{
  startCircle=null;
  log("‚Ü∫ Reset");
};

/* Toggle debug mode */
debugBtn.onclick = ()=>{
  debugMode = !debugMode;
  log(debugMode ? "üêõ Debug ON ‚Äî see ball mask + coords" : "‚úÖ Debug OFF");
};

/* Ball detection */
function detectBall(){
  let src = new cv.Mat(canvas.height,canvas.width,cv.CV_8UC4);
  new cv.VideoCapture(video).read(src);

  let hsv=new cv.Mat(); cv.cvtColor(src,hsv,cv.COLOR_RGBA2HSV);
  let low=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[0,0,185,0]);
  let high=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[180,60,255,255]);
  let mask=new cv.Mat(); cv.inRange(hsv,low,high,mask);

  let cnts=new cv.MatVector(), hier=new cv.Mat();
  cv.findContours(mask,cnts,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  let best=null, bestArea=0;
  for(let i=0;i<cnts.size();i++){
    let cnt=cnts.get(i);
    let a=cv.contourArea(cnt);
    if(a>bestArea){
      bestArea=a;
      let m=cv.moments(cnt);
      if(m.m00!==0) best = {x:m.m10/m.m00, y:m.m01/m.m00};
    }
  }

  // show mask debug
  if(debugMode){
    const w=200, h=120;
    let maskRGBA=new cv.Mat();
    cv.cvtColor(mask,maskRGBA,cv.COLOR_GRAY2RGBA);
    const imgData = new ImageData(
      new Uint8ClampedArray(maskRGBA.data), maskRGBA.cols, maskRGBA.rows
    );
    let temp=document.createElement("canvas");
    temp.width=maskRGBA.cols; temp.height=maskRGBA.rows;
    temp.getContext("2d").putImageData(imgData,0,0);
    ctx.drawImage(temp,canvas.width-w-10,10,w,h);
    maskRGBA.delete();
  }

  src.delete(); hsv.delete(); low.delete(); high.delete(); mask.delete(); cnts.delete(); hier.delete();
  return best;
}

/* Draw each frame */
function drawFrame(){
  ctx.save();
  ctx.scale(-1,1);
  ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);
  ctx.restore();

  // draw start circle
  if(startCircle){
    ctx.strokeStyle="cyan";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(startCircle.x,startCircle.y,startCircle.r,0,6.28);
    ctx.stroke();
  }

  if(cvReady){
    const pt = detectBall();
    if(pt){
      // Big marker so we SEE ball
      ctx.strokeStyle="#00eaff";
      ctx.lineWidth=4;
      ctx.beginPath();
      ctx.arc(pt.x, pt.y, 14, 0, 6.28);
      ctx.stroke();

      ctx.fillStyle="#00eaff";
      ctx.font="20px Arial";
      ctx.fillText(`Ball: ${pt.x.toFixed(0)},${pt.y.toFixed(0)}`, 10, 25);
    }
  }

  requestAnimationFrame(drawFrame);
}

/* OpenCV ready */
cv.onRuntimeInitialized = ()=>{
  cvReady = true;
  log("‚úÖ Vision engine loaded ‚Äî debug ball now");
};
</script>
</body>
</html>
