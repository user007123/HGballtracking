<!DOCTYPE html>
<html>
<head>
<title>HoverGreens Ball Vision</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  #canvas {
    display: block;
    margin: auto;
  }
  #status {
    margin-top: 10px;
    font-size: 22px;
  }
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas"></canvas>
<div id="status">ðŸŸ¢ Loading OpenCVâ€¦</div>

<!-- âœ… Load local opencv.js file -->
<script src="opencv.js"></script>

<script>
// DOM references
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let cap, src, gray, circles;
let ready = false;

// âœ… Start camera
function startCamera() {
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" },
    audio: false
  })
  .then(stream => {
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      video.play(); // force autoplay

      // match canvas to camera feed size
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      // OpenCV buffers
      src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
      gray = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
      circles = new cv.Mat();
      cap = new cv.VideoCapture(video);

      ready = true;
      document.getElementById("status").textContent =
        "ðŸ“· Camera started â€” place ball on green";
      requestAnimationFrame(loop);
    };
  })
  .catch(err => {
    document.getElementById("status").textContent = "âŒ Camera error: " + err;
  });
}

// âœ… Circle detection
function detectBallCircle(frame) {
  cv.cvtColor(frame, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(9, 9), 2, 2);

  circles = new cv.Mat();

  cv.HoughCircles(
    gray, circles, cv.HOUGH_GRADIENT,
    1, 20,
    100, 15,
    8, 40 // tuned for overhead golf ball
  );

  if (circles.rows > 0) {
    return {
      x: circles.data32F[0],
      y: circles.data32F[1],
      r: circles.data32F[2]
    };
  }

  return null;
}

// âœ… Main loop
function loop() {
  if (!ready || video.videoWidth === 0) {
    requestAnimationFrame(loop);
    return;
  }

  // draw camera feed to canvas first
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // read pixels into OpenCV buffer
  try {
    cap.read(src);
  } catch (e) {
    requestAnimationFrame(loop);
    return;
  }

  let ball = detectBallCircle(src);

  if (ball) {
    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "cyan";
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
    ctx.stroke();

    document.getElementById("status").textContent = "âœ… Ball detected!";
  }

  requestAnimationFrame(loop);
}

// âœ… OpenCV ready
cv.onRuntimeInitialized = () => {
  document.getElementById("status").textContent =
    "âœ… OpenCV loaded â€” starting cameraâ€¦";
  startCamera();
};
</script>
</body>
</html>
