<!DOCTYPE html>
<html>
<head>
<title>HoverGreens Ball Detector</title>
<style>
  body { margin:0; background:black; color:white; font-family:Arial; }
  #canvas { display:block; margin:auto; }
  #status { text-align:center; font-size:22px; margin-top:10px; }
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none;"></video>
<canvas id="canvas"></canvas>
<div id="status">ðŸŸ¢ Loading OpenCVâ€¦</div>

<!-- âœ… Load OpenCV -->
<script src="opencv.js"></script>

<script>
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
let cap;
let src, gray, circles;

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode:"environment" }})
    .then(stream => {
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
        circles = new cv.Mat();

        cap = new cv.VideoCapture(video);
        document.getElementById("status").textContent = "ðŸ“· Camera started â€” place ball on green";
        requestAnimationFrame(loop);
      };
    })
    .catch(err => { 
      document.getElementById("status").textContent = "âŒ Camera error: " + err; 
    });
}

// âœ… Detect circle (golf ball shape)
function detectBallCircle(frame) {
  cv.cvtColor(frame, gray, cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray, gray, new cv.Size(9,9), 2,2);

  try {
    cv.HoughCircles(
      gray, circles, cv.HOUGH_GRADIENT,
      1, 20,
      100, 15,
      8, 40   // min & max radius (tuned for overhead golf ball)
    );

    if (circles.rows > 0) {
      let x = circles.data32F[0];
      let y = circles.data32F[1];
      let r = circles.data32F[2];
      return { x, y, r };
    }
  } catch(e){}

  return null;
}

// âœ… Loop
function loop() {
  cap.read(src);
  cv.imshow(canvas, src);

  let ball = detectBallCircle(src);
  if(ball){
    // highlight ball
    ctx.beginPath();
    ctx.lineWidth = 4;
    ctx.strokeStyle = "cyan";
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.stroke();

    document.getElementById("status").textContent = "âœ… Ball detected";
  }

  requestAnimationFrame(loop);
}

// âœ… OpenCV init
cv['onRuntimeInitialized'] = () => {
  document.getElementById("status").textContent = "âœ… OpenCV loaded â€” starting cameraâ€¦";
  startCamera();
};
</script>
</body>
</html>
