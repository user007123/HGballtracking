<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>HoverGreens Vision â€” Sticky v2.5 (Fast Multi-Direction ROI + Camera Flip)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { color-scheme: dark }
  body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;text-align:center}
  header{padding:10px;display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
  button{background:#111;color:#fff;border:1px solid #333;border-radius:8px;padding:6px 12px;cursor:pointer}
  button:hover{border-color:#00ff88}
  #status{color:#00ff9c;font-size:14px}
  video{display:none}
  canvas{display:block;margin:8px auto;background:#000}
  #view{width:1180px;height:370px}
  #proc{display:none}
</style>
</head>
<body>

<header>
  <button id="resetBtn">Reset</button>
  <div id="status">Initializing cameraâ€¦</div>
</header>

<video id="cam" autoplay playsinline muted></video>
<canvas id="proc" width="960" height="540"></canvas>
<canvas id="view" width="1180" height="370"></canvas>

<script>
/* ===== DOM ===== */
const vid=document.getElementById("cam");
const proc=document.getElementById("proc"), pctx=proc.getContext("2d",{willReadFrequently:true});
const view=document.getElementById("view"), vctx=view.getContext("2d",{willReadFrequently:true});
const statusEl=document.getElementById("status");
const resetBtn=document.getElementById("resetBtn");

/* ===== TUNING ===== */
const ROI_SIZE=44;
const BRIGHT_MIN=200;
const SAT_MAX=0.14;
const AREA_MIN=4, AREA_MAX=380;
const ROUND_MAX=0.62;
const CONF_THRESH=0.52;

const STOP_EPS=1.0, STOP_FRAMES=6, GHOST_HOLD=5000;

const HOLD_FRAMES=3; // brief shadow tolerance
const NUDGE_MAX=1;   // tiny nudge only, almost invisible

/* ===== STATE ===== */
let roi=null;
let tracking=false;
let trail=[];
let lastBall=null;
let lastVel={x:0,y:0};
let hold=0, still=0, stopTime=null, lastFrame=null;

/* ===== HELPERS ===== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
function toProc(x,y){
  return {
    px:(view.width - x)*(proc.width/view.width),
    py:(view.height - y)*(proc.height/view.height) // vertical flip
  };
}
function drawTrail(){
  if(trail.length<2) return;
  vctx.strokeStyle="#00ff80";
  vctx.lineWidth=4;
  vctx.beginPath();
  vctx.moveTo(trail[0].x,trail[0].y);
  for(let i=1;i<trail.length;i++){vctx.lineTo(trail[i].x,trail[i].y);}
  vctx.stroke();
}

/* ===== CAMERA ===== */
navigator.mediaDevices.getUserMedia({
  video:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30},facingMode:"environment"},
  audio:false
}).then(s=>{
  vid.srcObject=s;
  vid.onloadedmetadata=()=>{ vid.play(); statusEl.textContent="âœ… Click on ball to lock"; loop(); };
}).catch(()=>statusEl.textContent="âŒ Camera blocked");

/* ===== RESET ===== */
function resetAll(){
  roi=null; tracking=false; trail=[]; lastBall=null; lastVel={x:0,y:0};
  hold=0; still=0; stopTime=null; lastFrame=null;
  statusEl.textContent="â†º Reset â€” click ball";
}
resetBtn.onclick=resetAll;

/* ===== CLICK TO LOCK ROI ===== */
view.addEventListener("click", e=>{
  const r=view.getBoundingClientRect();
  const x=(e.clientX-r.left)*(view.width/r.width);
  const y=(e.clientY-r.top)*(view.height/r.height);
  resetAll();
  roi={x:x-ROI_SIZE/2, y:y-ROI_SIZE/2};
  statusEl.textContent="ðŸŽ¯ Locked â€” roll";
});

/* ===== DETECTION ===== */
function detectBall(){
  if(!roi) return {found:false};
  const pr=toProc(roi.x,roi.y);
  const sx=Math.floor(pr.px), sy=Math.floor(pr.py);
  const sw=Math.floor(ROI_SIZE*(proc.width/view.width));
  const sh=Math.floor(ROI_SIZE*(proc.height/view.height));
  pctx.drawImage(vid,0,0,proc.width,proc.height);
  if(sw<1||sh<1||sx<0||sy<0||sx+sw>proc.width||sy+sh>proc.height) return {found:false};

  const img=pctx.getImageData(sx,sy,sw,sh).data;
  let count=0,sumX=0,sumY=0,sumBright=0,minX=1e9,maxX=-1e9,minY=1e9,maxY=-1e9;
  for(let i=0;i<img.length;i+=4){
    const R=img[i],G=img[i+1],B=img[i+2];
    const bright=(R+G+B)/3;
    const sat=(Math.max(R,G,B)-Math.min(R,G,B))/(Math.max(R,G,B)+1);
    if(bright>BRIGHT_MIN && sat<SAT_MAX){
      const px=(i/4)%sw, py=Math.floor((i/4)/sw);
      count++; sumX+=px; sumY+=py; sumBright+=bright;
      if(px<minX)minX=px; if(px>maxX)maxX=px;
      if(py<minY)minY=py; if(py>maxY)maxY=py;
    }
  }
  if(count<AREA_MIN||count>AREA_MAX) return {found:false};
  const w=maxX-minX, h=maxY-minY;
  if(w>32||h>32) return {found:false};
  const roundness=Math.abs(w-h)/Math.max(w,h||1);
  if(roundness>ROUND_MAX) return {found:false};

  const cxp=sx+(sumX/count), cyp=sy+(sumY/count);
  const vx=view.width/proc.width, vy=view.height/proc.height;
  const cx=view.width-(cxp*vx);
  const cy=view.height-(cyp*vy); // vertical flip convert back

  const meanBright=sumBright/count;
  const brightScore=Math.min(1,(meanBright-200)/40);
  const roundScore=Math.max(0,1-(roundness/ROUND_MAX));
  const conf=0.6*brightScore+0.4*roundScore;

  return {found:true,x:cx,y:cy,conf};
}

/* ===== MAIN LOOP ===== */
function loop(){
  requestAnimationFrame(loop);
  const now=performance.now();

  if(stopTime && now-stopTime<GHOST_HOLD){
    if(lastFrame) vctx.putImageData(lastFrame,0,0);
    drawTrail();
    return;
  }

  vctx.save();
  vctx.scale(-1,-1); // flip horizontally & vertically
  vctx.drawImage(vid,-view.width,-view.height,view.width,view.height);
  vctx.restore();

  drawTrail();

  if(roi){
    vctx.strokeStyle="#00ff88"; vctx.lineWidth=2;
    vctx.strokeRect(roi.x,roi.y,ROI_SIZE,ROI_SIZE);
  }

  const hit=detectBall();

  if(hit.found && hit.conf>=CONF_THRESH){
    const pt={x:hit.x,y:hit.y};
    trail.push(pt);
    if(lastBall){
      lastVel={x:pt.x-lastBall.x,y:pt.y-lastBall.y};
    }
    lastBall=pt;
    roi.x=pt.x-ROI_SIZE/2; roi.y=pt.y-ROI_SIZE/2;
    hold=0;
    vctx.fillStyle="#00ff6a";
    vctx.beginPath(); vctx.arc(pt.x,pt.y,4,0,2*Math.PI); vctx.fill();
    lastFrame=vctx.getImageData(0,0,view.width,view.height);
    if(!tracking){tracking=true;statusEl.textContent="ðŸš€ Tracking";}
  } else if(tracking && lastBall){
    hold++;
    if(hold<=HOLD_FRAMES){
      const mag=Math.hypot(lastVel.x,lastVel.y);
      if(mag>0.01){
        roi.x+=lastVel.x/mag*Math.min(NUDGE_MAX,mag);
        roi.y+=lastVel.y/mag*Math.min(NUDGE_MAX,mag);
      }
      trail.push(lastBall);
    }else{
      tracking=false;statusEl.textContent="âš ï¸ Lost â€” click to relock";
    }
  }

  if(trail.length>6){
    const a=trail.at(-1),b=trail.at(-5);
    const d=Math.hypot(a.x-b.x);
    still=(d<STOP_EPS)?still+1:0;
    if(still>STOP_FRAMES){
      stopTime=now;
      statusEl.textContent="â›³ Ball stopped";
      lastFrame=vctx.getImageData(0,0,view.width,view.height);
      return;
    }
  }
}
</script>
</body>
</html>
